{% extends "base.html" %}

{% block title %}Manage Students{% endblock %}

{% block nav_items %}
<li class="nav-item">
    <a class="nav-link" href="/admin/dashboard">
        <i class="fas fa-home me-1"></i>Dashboard
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/admin/enroll">
        <i class="fas fa-user-plus me-1"></i>Enroll Student
    </a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="/admin/students">
        <i class="fas fa-users me-1"></i>Students
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/admin/logout">
        <i class="fas fa-sign-out-alt me-1"></i>Logout
    </a>
</li>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="text-white fw-bold">
                    <i class="fas fa-users me-2"></i>Manage Students
                </h2>
                <p class="text-white-50">View and manage all enrolled students</p>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="dashboard-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">
                            <i class="fas fa-list text-primary me-2"></i>Student List
                        </h5>
                        <div>
                            <input type="text" id="searchInput" class="form-control" 
                                   placeholder="Search students..." style="display:inline-block; width:300px;">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Photo</th>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Semester</th>
                                    <th>Enrolled Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody">
                                {% for student_id, student in students.items() %}
                                <tr data-student-id="{{ student_id }}">
                                    <td>
                                        <img src="{{ url_for('static', filename='student_images/' + student_id + '.jpg') }}" 
                                             alt="{{ student.name }}" 
                                             class="img-thumbnail" 
                                             style="width:50px; height:50px; object-fit:cover;">
                                    </td>
                                    <td><strong>{{ student_id }}</strong></td>
                                    <td>{{ student.name }}</td>
                                    <td>{{ student.department }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ student.semester }}</span>
                                    </td>
                                    <td>{{ student.enrolled_date }}</td>
                                    <td>
                                        {% if student.blocked %}
                                        <span class="badge bg-danger">Blocked</span>
                                        {% else %}
                                        <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" 
                                                onclick="openMigrateModal('{{ student_id }}', '{{ student.semester }}')">
                                            <i class="fas fa-exchange-alt"></i>
                                        </button>
                                        <button class="btn btn-sm {% if student.blocked %}btn-success{% else %}btn-danger{% endif %}" 
                                                onclick="toggleBlock('{{ student_id }}', {{ student.blocked|tojson }})">
                                            <i class="fas fa-{% if student.blocked %}unlock{% else %}ban{% endif %}"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Migrate Semester Modal -->
<div class="modal fade" id="migrateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>Migrate Semester
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="migrateStudentId">
                <div class="mb-3">
                    <label class="form-label">Current Semester</label>
                    <input type="text" class="form-control" id="currentSemester" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">New Semester</label>
                    <select class="form-control" id="newSemester">
                        <option value="1st">1st Semester</option>
                        <option value="2nd">2nd Semester</option>
                        <option value="3rd">3rd Semester</option>
                        <option value="4th">4th Semester</option>
                        <option value="5th">5th Semester</option>
                        <option value="6th">6th Semester</option>
                        <option value="7th">7th Semester</option>
                        <option value="8th">8th Semester</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="migrateSemester()">
                    <i class="fas fa-check me-2"></i>Migrate
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#studentTableBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

function openMigrateModal(studentId, currentSemester) {
    document.getElementById('migrateStudentId').value = studentId;
    document.getElementById('currentSemester').value = currentSemester;
    const modal = new bootstrap.Modal(document.getElementById('migrateModal'));
    modal.show();
}

async function migrateSemester() {
    const studentId = document.getElementById('migrateStudentId').value;
    const newSemester = document.getElementById('newSemester').value;
    
    try {
        const response = await fetch('/admin/migrate_semester', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({student_id: studentId, new_semester: newSemester})
        });
        
        const data = await response.json();
        
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Semester migrated successfully',
                timer: 1500
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message
            });
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred'
        });
    }
}

async function toggleBlock(studentId, isBlocked) {
    const action = isBlocked ? 'unblock' : 'block';
    
    const result = await Swal.fire({
        title: `${action.charAt(0).toUpperCase() + action.slice(1)} Student?`,
        text: `Are you sure you want to ${action} this student?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: isBlocked ? '#10b981' : '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: `Yes, ${action}!`
    });
    
    if (result.isConfirmed) {
        try {
            const response = await fetch('/admin/block_student', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({student_id: studentId})
            });
            
            const data = await response.json();
            
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: `Student ${action}ed successfully`,
                    timer: 1500
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred'
            });
        }
    }
}
</script>
{% endblock %}